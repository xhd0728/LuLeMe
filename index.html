<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’¸äº†ä¹ˆ - ä»Šå¤©ä½ æ’¸äº†å—ï¼Ÿ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #050505;
            --bg-sidebar: #0f0f10;
            --bg-card: rgba(30, 30, 35, 0.6);
            --bg-hover: rgba(255, 255, 255, 0.08);
            --accent-pink: #ff2d75;
            --accent-cyan: #00f5ff;
            --accent-purple: #bd00ff;
            --accent-yellow: #ffd700;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --border-color: rgba(255, 255, 255, 0.1);
            --sidebar-width: 260px;
            --sidebar-collapsed: 0px;
            --shadow-card: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --glow-pink: 0 0 15px rgba(255, 45, 117, 0.5);
            --glow-cyan: 0 0 15px rgba(0, 245, 255, 0.5);
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(189, 0, 255, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(0, 245, 255, 0.05) 0%, transparent 40%);
            color: var(--text-primary);
            display: flex;
            overflow: hidden;
        }

        .hidden { display: none !important; }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        /* ========== ä¾§è¾¹æ  ========== */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background: rgba(15, 15, 16, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed);
            transform: translateX(calc(-1 * var(--sidebar-width)));
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-logo {
            font-family: 'ZCOOL KuaiLe', cursive;
            font-size: 1.6rem;
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sidebar-toggle {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .sidebar-toggle:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .sidebar-nav {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
        }

        .nav-item {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 6px;
            border-radius: 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            position: relative;
        }

        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(0, 245, 255, 0.1);
            color: var(--accent-cyan);
            font-weight: 600;
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 20px;
            background: var(--accent-cyan);
            border-radius: 0 4px 4px 0;
            box-shadow: var(--glow-cyan);
        }

        .nav-item .icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid var(--border-color);
        }

        .user-card {
            padding: 12px;
            border-radius: 12px;
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }
        
        .user-card:hover {
            border-color: rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 700;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-streak {
            font-size: 0.8rem;
            color: var(--accent-yellow);
        }

        .logout-btn {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .logout-btn:hover {
            background: rgba(255, 45, 117, 0.15);
            border-color: var(--accent-pink);
            color: var(--accent-pink);
        }

        /* ========== ç§»åŠ¨ç«¯ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’® ========== */
        .mobile-toggle {
            display: none;
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 200;
            width: 44px;
            height: 44px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-sidebar);
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* ========== ä¸»å†…å®¹åŒº ========== */
        .main-container {
            flex: 1;
            height: 100vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex: 1;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            padding: 40px 24px;
        }

        /* ========== é€šç”¨ç»„ä»¶ ========== */
        .panel {
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-card);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .panel:hover {
            border-color: rgba(255, 255, 255, 0.15);
        }

        .panel-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }

        .panel-desc {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .input {
            width: 100%;
            padding: 14px 16px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
            transition: all 0.2s;
        }

        .input:focus {
            border-color: var(--accent-cyan);
            background: rgba(0, 0, 0, 0.5);
            box-shadow: 0 0 0 3px rgba(0, 245, 255, 0.15);
        }

        .btn {
            padding: 14px 24px;
            border-radius: 12px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn.primary {
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple));
            color: #fff;
            box-shadow: 0 4px 15px rgba(189, 0, 255, 0.3);
        }

        .btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(189, 0, 255, 0.4);
            filter: brightness(1.1);
        }
        
        .btn.primary:active {
            transform: translateY(0);
        }

        .btn.ghost {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .btn.ghost:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--text-primary);
            color: #fff;
        }

        .btn.ghost:active {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn.full { width: 100%; }
        .btn.small { padding: 8px 14px; font-size: 0.85rem; }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .hint {
            font-size: 0.9rem;
            min-height: 22px;
            color: var(--text-secondary);
        }
        .hint.success { color: #22c55e; }
        .hint.error { color: #ef4444; }

        /* ========== ç™»å½•/æ³¨å†Œå¡ç‰‡ ========== */
        .auth-card {
            max-width: 400px;
            margin: 60px auto;
        }

        .auth-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .auth-tab.active {
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple));
            border-color: transparent;
            color: #fff;
        }

        /* ========== é¦–é¡µè§†å›¾ ========== */
        .view {
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .home-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .home-logo {
            font-family: 'ZCOOL KuaiLe', cursive;
            font-size: 3.5rem;
            background: linear-gradient(135deg, #fff 0%, var(--accent-pink) 50%, var(--accent-cyan) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            filter: drop-shadow(0 0 15px rgba(255, 45, 117, 0.4));
        }

        .home-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            letter-spacing: 1px;
        }

        .status-box {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .status-date {
            color: var(--accent-cyan);
            font-size: 1rem;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .status-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .status-text.done {
            color: var(--accent-pink);
            text-shadow: 0 0 10px rgba(255, 45, 117, 0.3);
        }

        .status-count {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-top: 12px;
            filter: drop-shadow(0 0 10px rgba(255, 45, 117, 0.3));
        }

        .clear-btn {
            margin-top: 16px;
        }

        /* ========== é¦™è•‰äº¤äº’åŒº ========== */
        .banana-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 50px;
        }

        .banana-box {
            width: 220px;
            height: 280px;
            border-radius: 24px;
            background: linear-gradient(180deg, rgba(255, 215, 0, 0.05) 0%, rgba(255, 45, 117, 0.05) 100%);
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255, 215, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: grab;
            touch-action: none;
            user-select: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5);
        }

        .banana-box:hover {
            border-color: var(--accent-yellow);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
        }

        .banana-box.active {
            border-color: var(--accent-pink);
            box-shadow: 0 0 40px rgba(255, 45, 117, 0.4);
            cursor: grabbing;
            transform: scale(0.98);
        }

        .banana {
            font-size: 6rem;
            transition: transform 0.1s ease-out;
            filter: drop-shadow(0 8px 20px rgba(0, 0, 0, 0.4));
        }

        .banana-hint {
            position: absolute;
            bottom: 12px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .banana-arrow {
            animation: bounceArrow 1s ease-in-out infinite;
        }

        @keyframes bounceArrow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* ç²’å­æ•ˆæœ */
        .particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: particleFly 0.8s ease-out forwards;
        }

        @keyframes particleFly {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }

        /* ========== æ—¥å† ========== */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .calendar-title {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .calendar-nav {
            display: flex;
            gap: 8px;
        }

        .calendar-nav button {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .calendar-nav button:hover {
            background: var(--bg-hover);
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
        }

        .weekday {
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-secondary);
            padding: 8px 0;
        }

        .days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            position: relative;
        }

        .day.current-month {
            color: var(--text-primary);
        }

        .day.today {
            background: rgba(0, 245, 255, 0.15);
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
            font-weight: 700;
        }

        .day.marked {
            background: rgba(255, 45, 117, 0.2);
            color: var(--accent-pink);
            font-weight: 700;
        }

        .day.marked::after {
            content: attr(data-count);
            position: absolute;
            bottom: 2px;
            right: 3px;
            font-size: 0.6rem;
            background: var(--accent-pink);
            color: #fff;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stats-row {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* ========== æ’è¡Œæ¦œ ========== */
        .leaderboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .board {
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
        }

        .board-title {
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--accent-cyan);
        }

        .board-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-radius: 8px;
            background: var(--bg-card);
            margin-bottom: 6px;
        }

        .board-rank {
            width: 32px;
            font-weight: 800;
            color: var(--accent-yellow);
        }

        .board-name {
            flex: 1;
            font-weight: 600;
        }

        .board-score {
            font-weight: 800;
            color: var(--accent-pink);
        }

        /* ========== æˆå°±ç³»ç»Ÿ ========== */
        .achievement-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .achievement {
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-dark);
        }

        .achievement.unlocked {
            border-color: var(--accent-pink);
            background: rgba(255, 45, 117, 0.05);
        }

        .ach-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .ach-name {
            font-weight: 700;
        }

        .ach-badge {
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 20px;
            background: var(--bg-hover);
        }

        .achievement.unlocked .ach-badge {
            background: var(--accent-pink);
            color: #fff;
        }

        .ach-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .progress-bar-bg {
            height: 6px;
            background: var(--bg-hover);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-pink), var(--accent-cyan));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* ========== å¯¹æˆ˜æ¨¡å— ========== */
        .battle-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 16px;
        }

        .battle-actions .input {
            flex: 1;
            min-width: 150px;
        }

        .battle-info {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 16px;
        }

        .battle-tag {
            padding: 8px 14px;
            border-radius: 20px;
            background: var(--bg-hover);
            font-size: 0.9rem;
        }

        .battle-tag.code {
            color: var(--accent-cyan);
            border: 1px solid var(--accent-cyan);
        }

        .battle-tag.timer {
            color: var(--accent-yellow);
        }

        .battle-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .battle-status {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 16px;
        }

        .battle-board {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .battle-rooms {
            margin: 16px 0;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .battle-rooms-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-weight: bold;
        }

        .battle-rooms-header h4 {
            margin: 0;
            font-size: 1rem;
            color: var(--accent-cyan);
        }

        .battle-rooms-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .battle-ranking-list,
        .battle-history-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .ranking-item,
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-hover);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .ranking-item .rank {
            width: 30px;
            font-weight: bold;
            color: var(--accent-yellow);
        }

        .ranking-item .name {
            flex: 1;
            margin: 0 12px;
        }

        .ranking-item .stats {
            display: flex;
            gap: 12px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .ranking-item .score {
            font-weight: bold;
            color: var(--accent-cyan);
        }

        .history-item .players {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-item .vs {
            color: var(--accent-pink);
            font-weight: bold;
        }

        .history-item .result {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .history-item .result.win {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }

        .history-item .result.lose {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
        }

        .history-item .result.draw {
            background: rgba(167, 139, 250, 0.2);
            color: #a78bfa;
        }

        .history-item .time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .room-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--bg-primary);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .room-info {
            display: flex;
            flex-direction: column;
        }

        .room-code {
            font-weight: bold;
            color: var(--accent-cyan);
        }

        .room-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
            font-style: italic;
        }

        /* ========== æˆå°±å¼¹çª— ========== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 2000;
        }

        .toast {
            min-width: 260px;
            padding: 14px 18px;
            border-radius: 12px;
            background: var(--bg-card);
            border: 1px solid var(--accent-pink);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 45, 117, 0.3);
            animation: toastIn 0.3s ease, toastOut 0.4s ease 2.8s forwards;
        }

        .toast-title {
            font-weight: 700;
            color: var(--accent-yellow);
            margin-bottom: 4px;
        }

        .toast-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes toastOut {
            to { opacity: 0; transform: translateX(50px); }
        }

        /* ========== å“åº”å¼ ========== */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                transform: translateX(calc(-1 * var(--sidebar-width)));
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .mobile-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .main-content {
                padding: 60px 16px 24px;
            }

            .home-logo {
                font-size: 2.2rem;
            }

            .banana-box {
                width: 160px;
                height: 200px;
            }

            .banana {
                font-size: 4.5rem;
            }

            .stats-row {
                gap: 20px;
            }

            .stat-value {
                font-size: 1.5rem;
            }
        }

        /* é®ç½©å±‚ */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 90;
        }

        @media (max-width: 768px) {
            .sidebar-overlay.active {
                display: block;
            }
        }
    </style>
</head>
<body>
    <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
    <button class="mobile-toggle" id="mobileToggle" onclick="toggleMobileSidebar()">â˜°</button>
    
    <!-- é®ç½©å±‚ -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobileSidebar()"></div>

    <!-- ä¾§è¾¹æ  -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-logo">æ’¸äº†ä¹ˆ</span>
            <button class="sidebar-toggle" onclick="toggleSidebar()" title="æ”¶èµ·ä¾§è¾¹æ ">
                <span id="toggleIcon">âœ•</span>
            </button>
        </div>

        <nav class="sidebar-nav">
            <button class="nav-item active" data-view="home" onclick="setView('home')">
                <span class="icon">ğŸ </span>
                <span>å¼€å§‹æ’¸</span>
            </button>
            <button class="nav-item" data-view="leaderboard" onclick="setView('leaderboard')">
                <span class="icon">ğŸ†</span>
                <span>æ’¸ç¥æ¦œ</span>
            </button>
            <button class="nav-item" data-view="achievements" onclick="setView('achievements')">
                <span class="icon">ğŸ–ï¸</span>
                <span>æˆå°±ç³»ç»Ÿ</span>
            </button>
            <button class="nav-item" data-view="battle" onclick="setView('battle')">
                <span class="icon">âš”ï¸</span>
                <span>å¾¡å‰å†³æ–—</span>
            </button>
            <button class="nav-item" data-view="settings" onclick="setView('settings')">
                <span class="icon">âš™ï¸</span>
                <span>è´¦æˆ·è®¾ç½®</span>
            </button>
        </nav>

        <div class="sidebar-footer" id="sidebarFooter">
            <div class="user-card hidden" id="userCard">
                <div class="user-avatar">ğŸ‘¤</div>
                <div class="user-info">
                    <div class="user-name" id="userName">--</div>
                    <div class="user-streak" id="userStreak">ğŸ”¥ è¿ç»­ 0 å¤©</div>
                </div>
                <button class="logout-btn" onclick="logout()">é€€å‡º</button>
            </div>
        </div>
    </aside>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-container">
        <div class="main-content">
            
            <!-- ç™»å½•/æ³¨å†Œå¡ç‰‡ -->
            <div class="auth-card panel" id="authCard">
                <div class="auth-tabs">
                    <button class="auth-tab active" data-mode="login" onclick="setAuthMode('login')">ç™»å½•</button>
                    <button class="auth-tab" data-mode="register" onclick="setAuthMode('register')">æ³¨å†Œ</button>
                </div>
                <div class="form-group">
                    <input class="input" id="usernameInput" placeholder="ç”¨æˆ·åï¼ˆè‡³å°‘3ä¸ªå­—ç¬¦ï¼‰" autocomplete="username">
                    <input class="input" id="passwordInput" type="password" placeholder="å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" autocomplete="current-password">
                    <button class="btn primary full" onclick="handleAuth()">å¼€å§‹æ’¸</button>
                    <div class="hint" id="authHint"></div>
                </div>
            </div>

            <!-- é¦–é¡µè§†å›¾ -->
            <div class="view hidden" id="viewHome" data-view="home">
                <div class="home-header">
                    <div class="home-logo">æ’¸äº†ä¹ˆ</div>
                    <div class="home-subtitle">è®°å½•æ¯ä¸€æ¬¡çš„å°ç¡®å¹¸ âœ¨</div>
                </div>

                <div class="status-box">
                    <div class="status-date" id="statusDate"></div>
                    <div class="status-text" id="statusText">ä»Šå¤©è¿˜æ²¡æ’¸å“¦~</div>
                    <div class="status-count hidden" id="statusCount"></div>
                    <button class="btn ghost small clear-btn hidden" id="clearBtn" onclick="clearTodayRecord()">æ¸…é™¤ä»Šæ—¥è®°å½•</button>
                </div>

                <div class="banana-container">
                    <div class="banana-box" id="bananaBox">
                        <div class="banana" id="banana">ğŸŒ</div>
                        <div class="banana-hint">
                            <span class="banana-arrow">â¬†ï¸â¬‡ï¸</span>
                            <span>ä¸Šä¸‹æ’¸ä¸€æ’¸</span>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="calendar-header">
                        <div class="calendar-title" id="calendarTitle">2024å¹´1æœˆ</div>
                        <div class="calendar-nav">
                            <button onclick="changeMonth(-1)">â—€</button>
                            <button onclick="changeMonth(1)">â–¶</button>
                        </div>
                    </div>
                    <div class="weekdays">
                        <div class="weekday">æ—¥</div>
                        <div class="weekday">ä¸€</div>
                        <div class="weekday">äºŒ</div>
                        <div class="weekday">ä¸‰</div>
                        <div class="weekday">å››</div>
                        <div class="weekday">äº”</div>
                        <div class="weekday">å…­</div>
                    </div>
                    <div class="days" id="calendarDays"></div>
                    <div class="stats-row">
                        <div class="stat-item">
                            <div class="stat-value" id="monthCount">0</div>
                            <div class="stat-label">æœ¬æœˆæ¬¡æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalCount">0</div>
                            <div class="stat-label">æ€»è®¡æ¬¡æ•°</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ’è¡Œæ¦œè§†å›¾ -->
            <div class="view hidden" id="viewLeaderboard" data-view="leaderboard">
                <div class="panel">
                    <div class="panel-title">ğŸ† æ’¸ç¥æ¦œ</div>
                    <div class="panel-desc">çœ‹çœ‹å…¨æœçš„çŒ›å£«ä»¬</div>
                    <div class="leaderboard-grid">
                        <div class="board">
                            <div class="board-title">æ€»æ¬¡æ•°æ¦œ</div>
                            <div id="totalBoard"></div>
                        </div>
                        <div class="board">
                            <div class="board-title">æœ¬æœˆæ¦œ</div>
                            <div id="monthBoard"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æˆå°±è§†å›¾ -->
            <div class="view hidden" id="viewAchievements" data-view="achievements">
                <div class="panel">
                    <div class="panel-title">ğŸ–ï¸ æˆå°±ç³»ç»Ÿ</div>
                    <div class="panel-desc">æ’¸å¾—å¤šã€è¿å¾—ä¹…ï¼Œå°±èƒ½è§£é”å¾½ç« </div>
                    <div class="achievement-list" id="achievementList"></div>
                </div>
            </div>

            <!-- å¯¹æˆ˜è§†å›¾ -->
            <div class="view hidden" id="viewBattle" data-view="battle">
                <div class="panel">
                    <div class="panel-title">âš”ï¸ å¾¡å‰å†³æ–— Â· 60ç§’</div>
                    <div class="panel-desc">é‚€è¯·å¥½å‹ä¸€èµ·æ’¸ï¼Œè®¡æ•°ä¸å…¥æ‰“å¡ | èƒœ+2åˆ† è´Ÿ-1åˆ† å¹³+1åˆ†</div>
                    
                    <!-- æˆ‘çš„æˆ˜ç»© -->
                    <div class="my-battle-stats" id="myBattleStats" style="display: flex; gap: 15px; margin-bottom: 15px; padding: 12px; background: var(--bg-hover); border-radius: 10px;">
                        <div style="flex: 1; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-cyan);" id="myBattleScore">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">ç§¯åˆ†</div>
                        </div>
                        <div style="flex: 1; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #4ade80;" id="myBattleWins">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">èƒœ</div>
                        </div>
                        <div style="flex: 1; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #f87171;" id="myBattleLosses">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">è´Ÿ</div>
                        </div>
                        <div style="flex: 1; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #a78bfa;" id="myBattleDraws">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">å¹³</div>
                        </div>
                    </div>
                    
                    <div class="battle-actions">
                        <button class="btn primary" onclick="createBattle()">ğŸ® åˆ›å»ºæˆ¿é—´</button>
                        <input class="input" id="joinCodeInput" placeholder="è¾“å…¥æˆ¿é—´ç ">
                        <button class="btn ghost" onclick="joinBattle()">â¡ï¸ åŠ å…¥</button>
                    </div>

                    <!-- æˆ¿é—´åˆ—è¡¨ -->
                    <div class="battle-rooms">
                        <div class="battle-rooms-header">
                            <h4>å¯ç”¨æˆ¿é—´</h4>
                            <button class="btn ghost small" onclick="refreshRooms()">ğŸ”„ åˆ·æ–°</button>
                        </div>
                        <div class="battle-rooms-list" id="battleRoomsList">
                            <div class="empty-state">æš‚æ— å¯ç”¨æˆ¿é—´</div>
                        </div>
                    </div>

                    <div class="battle-info">
                        <div class="battle-tag code" id="battleCodeTag">æœªåŠ å…¥æˆ¿é—´</div>
                        <div class="battle-tag timer" id="battleTimer">æœªå¼€å§‹</div>
                    </div>

                    <div class="battle-controls" id="battleControls">
                        <button class="btn primary" id="battleStartBtn" onclick="startBattle()">ğŸš€ å¼€å§‹å¯¹æˆ˜</button>
                        <button class="btn ghost" id="battleReadyBtn" onclick="toggleReady()">å‡†å¤‡</button>
                        <button class="btn ghost" onclick="leaveBattle()">ç¦»å¼€æˆ¿é—´</button>
                    </div>

                    <div class="battle-status" id="battleStatus">åˆ›å»ºæˆ–åŠ å…¥æˆ¿é—´åå³å¯å¼€å§‹ã€‚</div>
                    <div class="battle-board" id="battleBoard"></div>
                </div>

                <!-- å¯¹æˆ˜æ’è¡Œæ¦œ -->
                <div class="panel" style="margin-top: 20px;">
                    <div class="panel-title" style="display: flex; justify-content: space-between; align-items: center;">
                        ğŸ† å¯¹æˆ˜æ’è¡Œæ¦œ
                        <button class="btn ghost small" onclick="loadBattleRanking()">ğŸ”„</button>
                    </div>
                    <div id="battleRankingList" class="battle-ranking-list">
                        <div class="empty-state">åŠ è½½ä¸­...</div>
                    </div>
                </div>

                <!-- å¯¹æˆ˜å†å² -->
                <div class="panel" style="margin-top: 20px;">
                    <div class="panel-title" style="display: flex; justify-content: space-between; align-items: center;">
                        ğŸ“œ å¯¹æˆ˜å†å²
                        <button class="btn ghost small" onclick="loadBattleHistory()">ğŸ”„</button>
                    </div>
                    <div id="battleHistoryList" class="battle-history-list">
                        <div class="empty-state">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- è®¾ç½®è§†å›¾ -->
            <div class="view hidden" id="viewSettings" data-view="settings">
                <div class="panel">
                    <div class="panel-title">âš™ï¸ è´¦æˆ·è®¾ç½®</div>
                    <div class="panel-desc">ä¿®æ”¹ç”¨æˆ·å / ä¿®æ”¹å¯†ç  / å¿˜è®°å¯†ç é‡ç½®</div>

                    <div style="margin-bottom: 24px;">
                        <h4 style="margin-bottom: 12px; color: var(--accent-purple);">ä¿®æ”¹ç”¨æˆ·åï¼ˆéœ€ç™»å½•ï¼‰</h4>
                        <div class="form-group">
                            <input class="input" id="newUsernameInput" placeholder="æ–°ç”¨æˆ·åï¼ˆ>=3ä½ï¼‰">
                            <input class="input" id="usernameConfirmPwd" type="password" placeholder="ç¡®è®¤å¯†ç ">
                            <button class="btn primary" onclick="changeUsername()">ä¿®æ”¹ç”¨æˆ·å</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <h4 style="margin-bottom: 12px; color: var(--accent-cyan);">ä¿®æ”¹å¯†ç ï¼ˆéœ€ç™»å½•ï¼‰</h4>
                        <div class="form-group">
                            <input class="input" id="oldPwdInput" type="password" placeholder="åŸå¯†ç ">
                            <input class="input" id="newPwdInput" type="password" placeholder="æ–°å¯†ç ï¼ˆ>=6ä½ï¼‰">
                            <button class="btn primary" onclick="changePassword()">ä¿®æ”¹å¯†ç </button>
                        </div>
                    </div>

                    <div>
                        <h4 style="margin-bottom: 12px; color: var(--accent-yellow);">å¿˜è®°å¯†ç ï¼ˆæ— éœ€ç™»å½•ï¼‰</h4>
                        <div class="form-group">
                            <input class="input" id="resetUserInput" placeholder="ç”¨æˆ·å">
                            <input class="input" id="resetPwdInput" type="password" placeholder="æ–°å¯†ç ï¼ˆ>=6ä½ï¼‰">
                            <button class="btn ghost" onclick="resetPassword()">é‡ç½®å¯†ç </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ç²’å­å®¹å™¨ -->
    <div class="particles-container" id="particles"></div>

    <!-- æˆå°±å¼¹çª—å®¹å™¨ -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ========== çŠ¶æ€ç®¡ç† ==========
        const state = {
            user: null,
            summary: null,
            displayMonth: new Date(),
            recordsCache: {},
            leaderboard: null,
            authMode: 'login',
            currentView: 'home',
            battleCode: null,
            battleState: null,
            battleIsCreator: false,
            battleTimer: null,
        };

        // ========== å·¥å…·å‡½æ•° ==========
        const el = (id) => document.getElementById(id);
        const pad = (n) => String(n).padStart(2, '0');
        const monthKey = (d) => `${d.getFullYear()}-${pad(d.getMonth() + 1)}`;
        const formatDate = (d) => `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;

        // ========== API ==========
        const api = {
            async request(path, options = {}) {
                const res = await fetch(path, {
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
                    ...options,
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(data.message || 'è¯·æ±‚å¤±è´¥');
                return data;
            },
            login: (u, p) => api.request('/api/login', { method: 'POST', body: JSON.stringify({ username: u, password: p }) }),
            register: (u, p) => api.request('/api/register', { method: 'POST', body: JSON.stringify({ username: u, password: p }) }),
            logout: () => api.request('/api/logout', { method: 'POST' }),
            me: () => api.request('/api/me'),
            record: () => api.request('/api/record', { method: 'POST' }),
            clearToday: () => api.request('/api/record/today', { method: 'DELETE' }),
            records: (y, m) => api.request(`/api/records?year=${y}&month=${m}`),
            leaderboard: () => api.request('/api/leaderboard'),
            changePassword: (old_p, new_p) => api.request('/api/password/change', { method: 'POST', body: JSON.stringify({ old_password: old_p, new_password: new_p }) }),
            resetPassword: (u, new_p) => api.request('/api/password/reset', { method: 'POST', body: JSON.stringify({ username: u, new_password: new_p }) }),
            battleCreate: () => api.request('/api/battle/create', { method: 'POST' }),
            battleJoin: (code) => api.request('/api/battle/join', { method: 'POST', body: JSON.stringify({ code }) }),
            battleStart: (code) => api.request('/api/battle/start', { method: 'POST', body: JSON.stringify({ code }) }),
            battleTap: (code) => api.request('/api/battle/tap', { method: 'POST', body: JSON.stringify({ code }) }),
            battleState: (code) => api.request(`/api/battle/state?code=${code}`),
            battleRooms: () => api.request('/api/battle/rooms'),
            battleReady: (code, ready) => api.request('/api/battle/ready', { method: 'POST', body: JSON.stringify({ code, ready }) }),
            battleLeave: (code) => api.request('/api/battle/leave', { method: 'POST', body: JSON.stringify({ code }) }),
            battleSurrender: (code) => api.request('/api/battle/surrender', { method: 'POST', body: JSON.stringify({ code }) }),
            battleRematch: (code) => api.request('/api/battle/rematch', { method: 'POST', body: JSON.stringify({ code }) }),
            battleHistory: (limit = 20, offset = 0) => api.request(`/api/battle/history?limit=${limit}&offset=${offset}`),
            battleRanking: () => api.request('/api/battle/ranking'),
            changeUsername: (new_username, password) => api.request('/api/username/change', { method: 'POST', body: JSON.stringify({ new_username, password }) }),
        };

        // ========== è¯·æ±‚é™æµ ==========
        const rateLimiter = {
            tokens: 10,
            maxTokens: 10,
            lastRefill: Date.now(),
            refillRate: 1000, // 1ç§’æ¢å¤æ‰€æœ‰
            
            canRequest() {
                this.refill();
                return this.tokens > 0;
            },
            
            consume() {
                if (this.tokens > 0) {
                    this.tokens--;
                    return true;
                }
                return false;
            },
            
            refill() {
                const now = Date.now();
                const elapsed = now - this.lastRefill;
                if (elapsed >= this.refillRate) {
                    this.tokens = this.maxTokens;
                    this.lastRefill = now;
                }
            }
        };

        // ========== ä¾§è¾¹æ  ==========
        function toggleSidebar() {
            const sidebar = el('sidebar');
            sidebar.classList.toggle('collapsed');
            el('toggleIcon').textContent = sidebar.classList.contains('collapsed') ? 'â˜°' : 'âœ•';
        }

        function toggleMobileSidebar() {
            el('sidebar').classList.add('open');
            el('sidebarOverlay').classList.add('active');
        }

        function closeMobileSidebar() {
            el('sidebar').classList.remove('open');
            el('sidebarOverlay').classList.remove('active');
        }

        // ========== è§†å›¾åˆ‡æ¢ ==========
        function setView(view) {
            state.currentView = view;
            closeMobileSidebar();
            
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });

            document.querySelectorAll('.view').forEach(v => {
                v.classList.add('hidden');
            });

            const viewEl = el('view' + view.charAt(0).toUpperCase() + view.slice(1));
            if (viewEl) viewEl.classList.remove('hidden');

            // åˆ·æ–°å¯¹åº”è§†å›¾æ•°æ®
            if (view === 'leaderboard') loadLeaderboard();
            if (view === 'achievements') renderAchievements();
            if (view === 'battle') {
                refreshRooms();
                updateBattleUI();
                loadBattleRanking();
                loadBattleHistory();
                // å¦‚æœå·²ç»åœ¨æˆ¿é—´ä¸­ï¼Œå¯åŠ¨è½®è¯¢
                if (state.battleCode) {
                    startBattlePolling();
                }
            }
        }

        // ========== ç™»å½•/æ³¨å†Œ ==========
        function setAuthMode(mode) {
            state.authMode = mode;
            document.querySelectorAll('.auth-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
        }

        function showAuthCard(show) {
            el('authCard').classList.toggle('hidden', !show);
            el('viewHome').classList.toggle('hidden', show);
            el('userCard').classList.toggle('hidden', show);
        }

        function setHint(msg, type = 'info') {
            const hint = el('authHint');
            hint.textContent = msg;
            hint.className = `hint ${type}`;
        }

        async function handleAuth() {
            const username = el('usernameInput').value.trim();
            const password = el('passwordInput').value;
            
            if (username.length < 3) {
                setHint('ç”¨æˆ·åè‡³å°‘3ä¸ªå­—ç¬¦', 'error');
                return;
            }
            if (password.length < 6) {
                setHint('å¯†ç è‡³å°‘6ä½', 'error');
                return;
            }

            try {
                if (state.authMode === 'login') {
                    await api.login(username, password);
                    setHint('ç™»å½•æˆåŠŸï¼', 'success');
                } else {
                    await api.register(username, password);
                    setHint('æ³¨å†ŒæˆåŠŸï¼', 'success');
                }
                await loadUser();
            } catch (err) {
                setHint(err.message, 'error');
            }
        }

        async function loadUser() {
            try {
                const data = await api.me();
                state.user = data.user;
                state.summary = data.summary;
                state.displayMonth = new Date(data.summary.today);
                state.recordsCache[monthKey(state.displayMonth)] = data.records || {};
                
                showAuthCard(false);
                renderUserCard();
                refreshUI();
                await loadLeaderboard();
            } catch (err) {
                state.user = null;
                state.summary = null;
                showAuthCard(true);
            }
        }

        async function logout() {
            try { await api.logout(); } catch {}
            state.user = null;
            state.summary = null;
            state.recordsCache = {};
            showAuthCard(true);
            setHint('å·²é€€å‡ºç™»å½•', 'info');
        }

        function renderUserCard() {
            if (!state.user) return;
            el('userName').textContent = state.user.username;
            el('userStreak').textContent = `ğŸ”¥ è¿ç»­ ${state.summary?.current_streak || 0} å¤©`;
        }

        // ========== é¦™è•‰äº¤äº’ ==========
        function setupBanana() {
            const box = el('bananaBox');
            const banana = el('banana');
            if (!box || !banana) return;

            let startY = null;
            let isDragging = false;

            const onStart = (y) => {
                startY = y;
                isDragging = true;
                box.classList.add('active');
            };

            const onMove = (y) => {
                if (!isDragging || startY === null) return;
                const delta = Math.max(-80, Math.min(80, y - startY));
                banana.style.transform = `translateY(${delta * 0.6}px)`;
            };

            const onEnd = async (y) => {
                if (!isDragging || startY === null) return;
                const delta = y - startY;
                isDragging = false;
                startY = null;
                box.classList.remove('active');
                banana.style.transform = 'translateY(0)';

                if (Math.abs(delta) > 50) {
                    await handleStroke();
                }
            };

            // Pointer events
            box.addEventListener('pointerdown', (e) => {
                e.preventDefault();
                box.setPointerCapture(e.pointerId);
                onStart(e.clientY);
            });

            box.addEventListener('pointermove', (e) => {
                onMove(e.clientY);
            });

            box.addEventListener('pointerup', (e) => {
                onEnd(e.clientY);
            });

            box.addEventListener('pointercancel', () => {
                isDragging = false;
                startY = null;
                box.classList.remove('active');
                banana.style.transform = 'translateY(0)';
            });
        }

        async function handleStroke() {
            // è¯·æ±‚é™æµæ£€æŸ¥
            if (!rateLimiter.canRequest()) {
                console.log('è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œå·²é™æµ');
                return;
            }
            
            // å¯¹æˆ˜ä¼˜å…ˆ
            if (state.battleState && state.battleState.started && !state.battleState.finished && state.battleCode) {
                rateLimiter.consume();
                await battleTap();
                return;
            }
            rateLimiter.consume();
            await recordToday();
        }

        // æ’è¡Œæ¦œåˆ·æ–°è®¡æ•°å™¨ï¼Œé¿å…æ¯æ¬¡æ‰“å¡éƒ½åˆ·æ–°
        let leaderboardRefreshCounter = 0;

        async function recordToday() {
            if (!state.user) {
                showAuthCard(true);
                setHint('è¯·å…ˆç™»å½•', 'error');
                return;
            }

            const prevAch = state.summary?.achievements || [];
            
            try {
                const res = await api.record();
                state.summary = res.summary;
                state.recordsCache[monthKey(new Date(res.summary.today))] = res.records || {};
                
                createParticles();
                refreshUI();
                
                // æ£€æŸ¥æ–°æˆå°±
                const newAch = diffNewAchievements(prevAch, state.summary.achievements || []);
                showAchievementToasts(newAch);
                
                // æ¯5æ¬¡æ‰“å¡åˆ·æ–°ä¸€æ¬¡æ’è¡Œæ¦œï¼Œå‡å°‘APIè°ƒç”¨
                leaderboardRefreshCounter++;
                if (leaderboardRefreshCounter >= 5) {
                    leaderboardRefreshCounter = 0;
                    await loadLeaderboard();
                }
            } catch (err) {
                console.error(err);
            }
        }

        async function clearTodayRecord() {
            if (!state.user) return;
            try {
                const res = await api.clearToday();
                state.summary = res.summary;
                state.recordsCache[monthKey(new Date(res.summary.today))] = res.records || {};
                refreshUI();
                await loadLeaderboard();
            } catch (err) {
                console.error(err);
            }
        }

        function diffNewAchievements(prev, next) {
            const prevSet = new Set(prev.filter(a => a.unlocked).map(a => a.id));
            return next.filter(a => a.unlocked && !prevSet.has(a.id));
        }

        // ========== ç²’å­æ•ˆæœ ==========
        function createParticles() {
            const container = el('particles');
            const box = el('bananaBox');
            if (!box) return;
            
            const rect = box.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            
            const colors = ['#ff2d75', '#a855f7', '#00f5ff', '#ffd700', '#22c55e'];
            
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = cx + 'px';
                particle.style.top = cy + 'px';
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                
                const angle = (Math.PI * 2 * i) / 15;
                const dist = 80 + Math.random() * 60;
                particle.style.setProperty('--tx', `${Math.cos(angle) * dist}px`);
                particle.style.setProperty('--ty', `${Math.sin(angle) * dist}px`);
                
                container.appendChild(particle);
                setTimeout(() => particle.remove(), 800);
            }
        }

        // ========== æˆå°±å¼¹çª— ==========
        function showAchievementToasts(list) {
            if (!list || !list.length) return;
            const container = el('toastContainer');
            
            list.forEach((ach, idx) => {
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.innerHTML = `
                    <div class="toast-title">ğŸ‰ æˆå°±è§£é”: ${ach.name}</div>
                    <div class="toast-desc">${ach.desc}</div>
                `;
                container.appendChild(toast);
                setTimeout(() => toast.remove(), 3200 + idx * 200);
            });
        }

        // ========== çŠ¶æ€æ›´æ–° ==========
        function updateStatus() {
            const today = new Date();
            el('statusDate').textContent = today.toLocaleDateString('zh-CN', {
                year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
            });

            if (!state.summary) {
                el('statusText').textContent = 'è¯·å…ˆç™»å½•~';
                el('statusText').classList.remove('done');
                el('statusCount').classList.add('hidden');
                el('clearBtn').classList.add('hidden');
                return;
            }

            const count = state.summary.today_count || 0;
            const statusText = el('statusText');
            const statusCount = el('statusCount');
            const clearBtn = el('clearBtn');

            if (count === 0) {
                statusText.textContent = 'ä»Šå¤©è¿˜æ²¡æ’¸å“¦~';
                statusText.classList.remove('done');
                statusCount.classList.add('hidden');
                clearBtn.classList.add('hidden');
            } else {
                const messages = [
                    'ä»Šå¤©å·²ç»æ’¸è¿‡å•¦~ ğŸ’ª',
                    'åŒæ€ï¼ç²¾åŠ›å……æ²›ï¼ ğŸ”¥',
                    'ä¸‰è¿å‡»ï¼çŒ›ç”·æœ¬ç”·ï¼ âš¡',
                    'è¶…ç¥ï¼è¯·æ³¨æ„èº«ä½“ï¼ ğŸ’¥',
                    'ä¼ è¯´çº§ï¼ä½ æ˜¯è®¤çœŸçš„å—ï¼Ÿ ğŸ‘‘'
                ];
                statusText.textContent = messages[Math.min(count - 1, 4)];
                statusText.classList.add('done');
                statusCount.textContent = `Ã— ${count}`;
                statusCount.classList.remove('hidden');
                clearBtn.classList.remove('hidden');
            }
        }

        // ========== æ—¥å† ==========
        async function changeMonth(delta) {
            state.displayMonth.setMonth(state.displayMonth.getMonth() + delta);
            await ensureMonthRecords(state.displayMonth);
            renderCalendar();
        }

        async function ensureMonthRecords(dateObj) {
            const key = monthKey(dateObj);
            if (state.recordsCache[key]) return;
            try {
                const res = await api.records(dateObj.getFullYear(), dateObj.getMonth() + 1);
                state.recordsCache[key] = res.records || {};
            } catch {
                state.recordsCache[key] = {};
            }
        }

        function renderCalendar() {
            const year = state.displayMonth.getFullYear();
            const month = state.displayMonth.getMonth();
            const key = monthKey(state.displayMonth);
            const records = state.recordsCache[key] || {};

            el('calendarTitle').textContent = `${year}å¹´${month + 1}æœˆ`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            const todayStr = formatDate(new Date());

            let html = '';

            // ä¸Šæœˆ
            for (let i = firstDay - 1; i >= 0; i--) {
                html += `<div class="day">${daysInPrevMonth - i}</div>`;
            }

            // å½“æœˆ
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${pad(month + 1)}-${pad(d)}`;
                const count = records[dateStr] || 0;
                const isToday = dateStr === todayStr;
                const isMarked = count > 0;

                let cls = 'day current-month';
                if (isToday) cls += ' today';
                if (isMarked) cls += ' marked';

                html += `<div class="${cls}"${isMarked ? ` data-count="${count}"` : ''}>${d}</div>`;
            }

            // ä¸‹æœˆè¡¥é½
            const total = firstDay + daysInMonth;
            const remaining = total > 35 ? 42 - total : 35 - total;
            for (let d = 1; d <= remaining; d++) {
                html += `<div class="day">${d}</div>`;
            }

            el('calendarDays').innerHTML = html;
        }

        function updateStats() {
            el('monthCount').textContent = state.summary?.month_count || 0;
            el('totalCount').textContent = state.summary?.total_count || 0;
        }

        // ========== æ’è¡Œæ¦œ ==========
        async function loadLeaderboard() {
            try {
                state.leaderboard = await api.leaderboard();
                renderLeaderboard();
            } catch {
                state.leaderboard = null;
            }
        }

        function renderLeaderboard() {
            const renderBoard = (items) => {
                if (!items || !items.length) return '<div style="color:var(--text-secondary);padding:12px;">æš‚æ— æ•°æ®</div>';
                return items.map(item => `
                    <div class="board-item">
                        <span class="board-rank">#${item.rank}</span>
                        <span class="board-name">${item.username}</span>
                        <span class="board-score">${item.total}</span>
                    </div>
                `).join('');
            };

            el('totalBoard').innerHTML = renderBoard(state.leaderboard?.total || []);
            el('monthBoard').innerHTML = renderBoard(state.leaderboard?.month || []);
        }

        // ========== æˆå°± ==========
        function renderAchievements() {
            const list = state.summary?.achievements || [];
            if (!list.length) {
                el('achievementList').innerHTML = '<div style="color:var(--text-secondary);padding:12px;">ç™»å½•åæŸ¥çœ‹æˆå°±</div>';
                return;
            }

            el('achievementList').innerHTML = list.map(ach => {
                const ratio = Math.min(1, (ach.progress || 0) / ach.target);
                return `
                    <div class="achievement ${ach.unlocked ? 'unlocked' : ''}">
                        <div class="ach-header">
                            <span class="ach-name">${ach.name}</span>
                            <span class="ach-badge">${ach.unlocked ? 'å·²è§£é”' : `${ach.progress}/${ach.target}`}</span>
                        </div>
                        <div class="ach-desc">${ach.desc}</div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" style="width:${ratio * 100}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== å¯¹æˆ˜ ==========
        async function createBattle() {
            if (!state.user) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            try {
                const res = await api.battleCreate();
                state.battleCode = res.code;
                state.battleIsCreator = true;
                state.battleState = res.state;
                startBattlePolling(); // åˆ›å»ºæˆ¿é—´åç«‹å³å¼€å§‹è½®è¯¢
                updateBattleUI();
            } catch (err) {
                alert(err.message);
            }
        }

        async function refreshRooms() {
            if (!state.user) return;
            try {
                const res = await api.battleRooms();
                renderRoomsList(res.rooms);
            } catch (err) {
                console.error('åˆ·æ–°æˆ¿é—´åˆ—è¡¨å¤±è´¥:', err);
            }
        }

        function renderRoomsList(rooms) {
            const listEl = el('battleRoomsList');
            if (!rooms || rooms.length === 0) {
                listEl.innerHTML = '<div class="empty-state">æš‚æ— å¯ç”¨æˆ¿é—´</div>';
                return;
            }
            listEl.innerHTML = rooms.map(room => `
                <div class="room-item">
                    <div class="room-info">
                        <div class="room-code">æˆ¿é—´ ${room.code}</div>
                        <div class="room-meta">æˆ¿ä¸»: ${room.creator_name} | ${room.player_count}äººå·²åŠ å…¥</div>
                    </div>
                    <button class="btn primary small" onclick="joinBattleByCode('${room.code}')">åŠ å…¥</button>
                </div>
            `).join('');
        }

        async function joinBattle() {
            const code = el('joinCodeInput').value.trim();
            if (!code) {
                alert('è¯·è¾“å…¥æˆ¿é—´ç ');
                return;
            }
            await joinBattleByCode(code);
        }

        async function joinBattleByCode(code) {
            if (!state.user) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            try {
                const res = await api.battleJoin(code);
                state.battleCode = code;
                state.battleIsCreator = false;
                state.battleState = res.state;
                startBattlePolling(); // åŠ å…¥æˆ¿é—´åå¼€å§‹è½®è¯¢
                updateBattleUI();
            } catch (err) {
                alert(err.message);
            }
        }

        async function toggleReady() {
            if (!state.battleCode || !state.user) return;
            try {
                // è·å–å½“å‰ç©å®¶çš„å‡†å¤‡çŠ¶æ€
                const currentPlayer = state.battleState.players.find(p => String(p.user_id) === String(state.user.id));
                const currentReady = currentPlayer ? currentPlayer.ready : false;
                const newReady = !currentReady;
                const res = await api.battleReady(state.battleCode, newReady);
                state.battleState = res.state;
                updateBattleUI();
            } catch (err) {
                alert(err.message);
            }
        }

        async function startBattle() {
            if (!state.battleCode) return;
            try {
                const res = await api.battleStart(state.battleCode);
                state.battleState = res.state;
                startBattlePolling();
                updateBattleUI();
            } catch (err) {
                console.error('Battle start error:', err);
                alert(err.message || 'å¼€å§‹å¯¹æˆ˜å¤±è´¥');
            }
        }

        async function battleTap() {
            if (!state.battleCode) return;
            try {
                const res = await api.battleTap(state.battleCode);
                state.battleState = res.state;
                // å¦‚æœå¯¹æˆ˜è¿›è¡Œä¸­ï¼Œåªæ›´æ–°è®¡æ•°ï¼Œä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªDOM
                if (state.battleState.started && !state.battleState.finished) {
                    // ç¡®ä¿DOMå…ƒç´ å­˜åœ¨åå†æ›´æ–°
                    if (el('battleCount') && el('battleLiveRank')) {
                        updateBattleCountsOnly();
                    } else {
                        // å¦‚æœDOMå…ƒç´ ä¸å­˜åœ¨ï¼Œé‡æ–°æ¸²æŸ“æ•´ä¸ªç•Œé¢
                        updateBattleUI();
                    }
                } else {
                    updateBattleUI();
                }
            } catch {}
        }

        async function surrenderBattle() {
            if (!state.battleCode) return;
            if (!confirm('ç¡®å®šè¦æŠ•é™å—ï¼Ÿå¯¹æ–¹å°†ç›´æ¥è·èƒœï¼')) return;
            try {
                const res = await api.battleSurrender(state.battleCode);
                state.battleState = res.state;
                updateBattleUI();
            } catch (err) {
                alert(err.message || 'æŠ•é™å¤±è´¥');
            }
        }

        async function leaveBattle() {
            if (!state.battleCode) return;
            try {
                const res = await api.battleLeave(state.battleCode);
                if (res.room_deleted) {
                    // æˆ¿é—´å·²è§£æ•£
                    alert('æˆ¿é—´å·²è§£æ•£');
                } else if (res.new_creator) {
                    // å½“å‰ç”¨æˆ·è¢«è®¾ä¸ºæ–°æˆ¿ä¸»
                    alert('æˆ¿ä¸»å·²ç¦»å¼€ï¼Œä½ æˆä¸ºäº†æ–°æˆ¿ä¸»');
                    state.battleIsCreator = true;
                    state.battleState = res.state;
                    updateBattleUI();
                    return;
                } else {
                    // æ­£å¸¸ç¦»å¼€
                    alert('å·²ç¦»å¼€æˆ¿é—´');
                }
                // é‡ç½®çŠ¶æ€
                state.battleCode = null;
                state.battleState = null;
                state.battleIsCreator = false;
                if (state.battleTimer) {
                    clearInterval(state.battleTimer);
                    state.battleTimer = null;
                }
                // ç§»é™¤é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
                document.removeEventListener('keydown', handleBattleKey);
                updateBattleUI();
                // åˆ·æ–°æˆ¿é—´åˆ—è¡¨
                if (state.currentView === 'battle') {
                    refreshRooms();
                }
            } catch (err) {
                alert(err.message || 'ç¦»å¼€æˆ¿é—´å¤±è´¥');
            }
        }

        function startBattlePolling() {
            if (state.battleTimer) clearInterval(state.battleTimer);
            // æ ¹æ®å¯¹æˆ˜çŠ¶æ€ä½¿ç”¨ä¸åŒçš„è½®è¯¢é—´éš”
            state.battleTimer = setInterval(async () => {
                if (!state.battleCode) {
                    clearInterval(state.battleTimer);
                    return;
                }
                try {
                    const res = await api.battleState(state.battleCode);
                    // æ£€æŸ¥æ˜¯å¦æœ‰é‡è¦çŠ¶æ€å˜åŒ–
                    const wasStarted = state.battleState?.started;
                    const wasFinished = state.battleState?.finished;
                    const isStarted = res.state.started;
                    const isFinished = res.state.finished;
                    
                    // åªåœ¨çŠ¶æ€å˜åŒ–æ—¶æ›´æ–°UI
                    if (isStarted && !wasStarted) {
                        state.battleState = res.state;
                        updateBattleUI();
                    } else if (isFinished && !wasFinished) {
                        state.battleState = res.state;
                        updateBattleUI();
                    } else if (isStarted && !isFinished) {
                        // å¯¹æˆ˜è¿›è¡Œä¸­ï¼Œåªæ›´æ–°æ¬¡æ•°å’Œæ’åï¼Œä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªDOM
                        state.battleState = res.state;
                        updateBattleCountsOnly();
                    } else if (!isStarted && !isFinished) {
                        // å¯¹æˆ˜æœªå¼€å§‹æ—¶ï¼Œä¹Ÿè¦æ›´æ–°UIä»¥æ˜¾ç¤ºæ–°åŠ å…¥çš„ç©å®¶
                        state.battleState = res.state;
                        updateBattleUI();
                    }
                    
                    if (isFinished) {
                        clearInterval(state.battleTimer);
                        // ç§»é™¤é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
                        document.removeEventListener('keydown', handleBattleKey);
                    }
                } catch (err) {
                    console.error('Polling error:', err);
                    // å¦‚æœæˆ¿é—´ä¸å­˜åœ¨æˆ–è¿‡æœŸï¼Œåœæ­¢è½®è¯¢å¹¶é‡ç½®çŠ¶æ€
                    if (err.message && (err.message.includes('æˆ¿é—´ä¸å­˜åœ¨') || err.message.includes('å·²è¿‡æœŸ'))) {
                        clearInterval(state.battleTimer);
                        state.battleTimer = null;
                        state.battleCode = null;
                        state.battleState = null;
                        state.battleIsCreator = false;
                        document.removeEventListener('keydown', handleBattleKey);
                        updateBattleUI();
                        alert('æˆ¿é—´å·²ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ');
                    }
                }
            }, 500); // ç¼©çŸ­è½®è¯¢é—´éš”åˆ°500msï¼Œæé«˜å“åº”é€Ÿåº¦
        }

        function updateBattleCountsOnly() {
            if (!state.battleState || !state.battleState.started || state.battleState.finished) return;
            
            const players = state.battleState.players;
            const sorted = [...players].sort((a, b) => (b.count || 0) - (a.count || 0));
            
            // åªæ›´æ–°å®æ—¶æ’åéƒ¨åˆ†
            const rankContainer = el('battleLiveRank');
            const countContainer = el('battleCount');
            
            if (rankContainer) {
                rankContainer.innerHTML = sorted.map((player, idx) => `
                    <div class="board-item">
                        <span class="board-rank">#${idx + 1}</span>
                        <span class="board-name">${player.username}</span>
                        <span class="board-score">${player.count || 0}æ¬¡</span>
                    </div>
                `).join('');
            }
            
            if (countContainer) {
                // ç¡®ä¿ç±»å‹ä¸€è‡´ï¼Œå°†user_idè½¬ä¸ºå­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒ
                const currentPlayer = players.find(p => String(p.user_id) === String(state.user.id));
                countContainer.innerHTML = `ä½ çš„æ¬¡æ•°: <strong>${currentPlayer ? currentPlayer.count || 0 : 0}</strong>`;
            }
            
            // æ›´æ–°å€’è®¡æ—¶
            const timer = el('battleTimer');
            if (timer) {
                const remaining = Math.max(0, Math.ceil(state.battleState.remaining));
                timer.textContent = `å‰©ä½™ ${remaining}s`;
            }
        }

        function updateBattleUI() {
            const codeTag = el('battleCodeTag');
            const timer = el('battleTimer');
            const status = el('battleStatus');
            const board = el('battleBoard');
            const startBtn = el('battleStartBtn');
            const readyBtn = el('battleReadyBtn');
            const battleControls = el('battleControls');
            const leaveBtn = battleControls?.querySelector('button:last-child');

            if (!state.battleCode || !state.battleState) {
                codeTag.textContent = 'æœªåŠ å…¥æˆ¿é—´';
                timer.textContent = 'æœªå¼€å§‹';
                status.textContent = 'åˆ›å»ºæˆ–åŠ å…¥æˆ¿é—´åå³å¯å¼€å§‹ã€‚';
                board.innerHTML = '';
                // æœªåŠ å…¥æˆ¿é—´æ—¶éšè—æ•´ä¸ªbattle-controlså®¹å™¨
                if (battleControls) {
                    battleControls.style.display = 'none';
                }
                return;
            }
            
            // åŠ å…¥æˆ¿é—´åæ˜¾ç¤ºbattle-controlså®¹å™¨
            if (battleControls) {
                battleControls.style.display = 'flex';
            }

            const s = state.battleState;
            codeTag.textContent = `æˆ¿é—´: ${state.battleCode}`;

            // å½“å‰ç©å®¶ä¿¡æ¯
            const currentPlayer = state.user ? s.players.find(p => String(p.user_id) === String(state.user.id)) : null;
            const isReady = currentPlayer ? currentPlayer.ready : false;

            if (s.finished) {
                timer.textContent = 'å·²ç»“æŸ';
                status.textContent = 'å¯¹æˆ˜ç»“æŸï¼';
                startBtn.disabled = true;
                startBtn.style.display = 'none';
                readyBtn.style.display = 'none';
                // å¯¹æˆ˜ç»“æŸæ—¶æ˜¾ç¤ºç¦»å¼€æŒ‰é’®
                if (leaveBtn) {
                    leaveBtn.style.display = 'inline-block';
                    leaveBtn.textContent = 'ç¦»å¼€æˆ¿é—´';
                }
                renderBattleResult(s.players);
            } else if (s.started) {
                const remaining = Math.max(0, Math.ceil(s.remaining));
                timer.textContent = `å‰©ä½™ ${remaining}s`;
                status.textContent = 'å¯¹æˆ˜è¿›è¡Œä¸­ï¼Œç–¯ç‹‚æ’¸åŠ¨é¦™è•‰ï¼';
                startBtn.disabled = true;
                startBtn.style.display = 'none';
                readyBtn.style.display = 'none';
                // å¯¹æˆ˜è¿›è¡Œä¸­æ˜¾ç¤ºç¦»å¼€æŒ‰é’®
                if (leaveBtn) {
                    leaveBtn.style.display = 'inline-block';
                    leaveBtn.textContent = 'ç¦»å¼€æˆ¿é—´';
                }
                renderBattleInProgress(s.players);
            } else {
                timer.textContent = 'ç­‰å¾…å¼€å§‹';
                // è®¡ç®—å·²å‡†å¤‡ç©å®¶æ•°é‡
                const readyCount = s.players.filter(p => p.ready).length;
                const totalCount = s.players.length;
                status.textContent = `å·²æœ‰ ${totalCount} äººåŠ å…¥ï¼Œ${readyCount} äººå·²å‡†å¤‡ï¼Œæˆ¿ä¸»å¯å¼€å§‹ã€‚`;
                
                // åªæœ‰æˆ¿ä¸»å¯ä»¥çœ‹åˆ°å¼€å§‹æŒ‰é’®
                startBtn.style.display = state.battleIsCreator ? 'inline-block' : 'none';
                startBtn.disabled = false; // æˆ¿ä¸»å§‹ç»ˆå¯ä»¥ç‚¹å‡»å¼€å§‹
                
                // æ˜¾ç¤ºå‡†å¤‡æŒ‰é’®
                readyBtn.style.display = 'inline-block';
                readyBtn.textContent = isReady ? 'å–æ¶ˆå‡†å¤‡' : 'å‡†å¤‡';
                readyBtn.className = isReady ? 'btn primary' : 'btn ghost';
                
                // æ ¹æ®ç©å®¶æ•°é‡å’Œæˆ¿ä¸»çŠ¶æ€æ›´æ–°ç¦»å¼€æŒ‰é’®
                if (leaveBtn) {
                    leaveBtn.style.display = 'inline-block';
                    if (state.battleIsCreator && totalCount === 1) {
                        // æˆ¿ä¸»æ˜¯æˆ¿é—´çš„æœ€åä¸€ä¸ªäººï¼Œæ˜¾ç¤ºè§£æ•£æˆ¿é—´
                        leaveBtn.textContent = 'è§£æ•£æˆ¿é—´';
                    } else {
                        // æ˜¾ç¤ºç¦»å¼€æˆ¿é—´
                        leaveBtn.textContent = 'ç¦»å¼€æˆ¿é—´';
                    }
                }
                
                renderPlayerList(s.players);
            }
        }

        function renderPlayerList(players) {
            const board = el('battleBoard');
            const sorted = [...players].sort((a, b) => {
                // å…ˆæŒ‰å‡†å¤‡çŠ¶æ€æ’åºï¼Œå†æŒ‰ç”¨æˆ·åæ’åº
                if (a.ready !== b.ready) {
                    return a.ready ? -1 : 1;
                }
                return a.username.localeCompare(b.username);
            });
            board.innerHTML = sorted.map((player, idx) => `
                <div class="board-item">
                    <span class="board-rank">${player.ready ? 'âœ…' : 'â³'}</span>
                    <span class="board-name">${player.username}</span>
                    <span class="board-status">${player.ready ? 'å·²å‡†å¤‡' : 'æœªå‡†å¤‡'}</span>
                </div>
            `).join('');
        }

        // è®¾ç½®å¯¹æˆ˜é¦™è•‰äº¤äº’
        function setupBattleBanana() {
            const box = el('battleBananaBox');
            const banana = el('battleBanana');
            if (!box || !banana) return;

            let startY = null;
            let isDragging = false;

            const onStart = (y) => {
                startY = y;
                isDragging = true;
                box.classList.add('active');
            };

            const onMove = (y) => {
                if (!isDragging || startY === null) return;
                const delta = Math.max(-80, Math.min(80, y - startY));
                banana.style.transform = `translateY(${delta * 0.6}px)`;
            };

            const onEnd = async (y) => {
                if (!isDragging || startY === null) return;
                const delta = y - startY;
                isDragging = false;
                startY = null;
                box.classList.remove('active');
                banana.style.transform = 'translateY(0)';

                if (Math.abs(delta) > 50) {
                    // è¯·æ±‚é™æµæ£€æŸ¥
                    if (rateLimiter.canRequest()) {
                        rateLimiter.consume();
                        await battleTap();
                    }
                }
            };

            // Pointer events
            box.addEventListener('pointerdown', (e) => {
                e.preventDefault();
                box.setPointerCapture(e.pointerId);
                onStart(e.clientY);
            });

            box.addEventListener('pointermove', (e) => {
                onMove(e.clientY);
            });

            box.addEventListener('pointerup', (e) => {
                onEnd(e.clientY);
            });

            box.addEventListener('pointercancel', () => {
                isDragging = false;
                startY = null;
                box.classList.remove('active');
                banana.style.transform = 'translateY(0)';
            });
        }

        function renderBattleInProgress(players) {
            const board = el('battleBoard');
            const sorted = [...players].sort((a, b) => (b.count || 0) - (a.count || 0));
            
            board.innerHTML = `
                <!-- å¯¹æˆ˜é¦™è•‰åŒºåŸŸ -->
                <div class="battle-banana-container">
                    <div class="banana-box" id="battleBananaBox" style="margin: 20px auto; text-align: center;">
                        <div class="banana" id="battleBanana" style="font-size: 60px; cursor: pointer; transition: transform 0.1s ease;">ğŸŒ</div>
                        <div class="banana-hint">
                            <span class="banana-arrow">â¬†ï¸â¬‡ï¸</span>
                            <span>ç–¯ç‹‚ä¸Šä¸‹æ’¸åŠ¨ï¼</span>
                        </div>
                    </div>
                    
                    <!-- å¯¹æˆ˜æ§åˆ¶æŒ‰é’® -->
                    <div style="text-align: center; margin: 15px 0;">
                        <button class="btn ghost" onclick="surrenderBattle()" style="border-color: #ff6b6b; color: #ff6b6b;">ğŸ³ï¸ æŠ•é™</button>
                    </div>
                    
                    <!-- å®æ—¶è®¡æ•° -->
                    <div class="battle-count" id="battleCount" style="text-align: center; font-size: 1.2rem; margin: 10px 0;">
                        ä½ çš„æ¬¡æ•°: <strong>${(() => {
                            if (!state.user) return 0;
                            // å…ˆä»å½“å‰playersæ•°ç»„ä¸­ç›´æ¥æŸ¥æ‰¾ï¼Œç¡®ä¿è·å–æœ€æ–°æ•°æ®
                            const currentPlayer = players.find(p => String(p.user_id) === String(state.user.id));
                            if (currentPlayer) return currentPlayer.count || 0;
                            // åå¤‡æ–¹æ¡ˆï¼šä»æ’åºåçš„æ•°ç»„ä¸­æŸ¥æ‰¾
                            const sortedPlayer = sorted.find(p => String(p.user_id) === String(state.user.id));
                            return sortedPlayer ? sortedPlayer.count || 0 : 0;
                        })()}</strong>
                    </div>
                    
                    <!-- å®æ—¶æ¦œå• -->
                    <div class="battle-live-rank" id="battleLiveRank" style="margin-top: 20px;">
                        <h4 style="margin-bottom: 10px; color: var(--accent-cyan);">å®æ—¶æ’å</h4>
                        ${sorted.map((player, idx) => `
                            <div class="board-item">
                                <span class="board-rank">#${idx + 1}</span>
                                <span class="board-name">${player.username}</span>
                                <span class="board-score">${player.count || 0}æ¬¡</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // è®¾ç½®å¯¹æˆ˜é¦™è•‰äº¤äº’
            setupBattleBanana();
            
            // å…ˆç§»é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé˜²æ­¢é‡å¤ç»‘å®š
            document.removeEventListener('keydown', handleBattleKey);
            
            // ä¸ºé¦™è•‰æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆå¸¦é™æµï¼‰
            const battleBanana = el('battleBanana');
            if (battleBanana) {
                battleBanana.addEventListener('click', () => {
                    if (rateLimiter.canRequest()) {
                        rateLimiter.consume();
                        battleTap();
                    }
                });
                // æ”¯æŒé”®ç›˜ä¸Šä¸‹ç®­å¤´
                document.addEventListener('keydown', handleBattleKey);
            }
        }

        function renderBattleResult(players) {
            const board = el('battleBoard');
            const sorted = [...players].sort((a, b) => (b.count || 0) - (a.count || 0));
            
            // æ£€æŸ¥ç»“æœç±»å‹
            const surrenderResult = state.battleState?.surrender_result;
            const winnerId = state.battleState?.winner_id;
            const surrendered = state.battleState?.surrendered || [];
            // å°† surrendered æ•°ç»„ä¸­çš„ ID ç»Ÿä¸€è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œæ–¹ä¾¿æ¯”è¾ƒ
            const surrenderedStr = surrendered.map(id => String(id));
            
            // åˆ¤æ–­æ˜¯å¦å¹³å±€ï¼ˆç¬¬ä¸€åå’Œç¬¬äºŒåæ¬¡æ•°ç›¸åŒï¼‰
            const isDraw = !surrenderResult && sorted.length >= 2 && (sorted[0].count || 0) === (sorted[1].count || 0);
            
            // ç¡®å®šå½“å‰ç”¨æˆ·çš„è§’è‰²
            let isWinner = false;
            let isSurrendered = false;
            let resultTitle = '';
            let resultColor = '';
            let winner = null;
            
            // å…ˆå°è¯•æ‰¾åˆ° winnerï¼Œç¡®ä¿ä¸ä¸º null
            if (winnerId !== null && winnerId !== undefined) {
                winner = players.find(p => String(p.user_id) === String(winnerId));
            }
            // å¦‚æœæ²¡æ‰¾åˆ° winnerï¼Œä½¿ç”¨æ’åç¬¬ä¸€çš„ç©å®¶
            if (!winner && sorted.length > 0) {
                winner = sorted[0];
            }
            // å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤å¯¹è±¡é˜²æ­¢é”™è¯¯
            if (!winner) {
                winner = { username: 'æœªçŸ¥', count: 0, user_id: '' };
            }
            
            if (surrenderResult === 'draw') {
                resultTitle = 'ğŸ¤ å¹³å±€ï¼';
                resultColor = '#a855f7';
            } else if (surrenderResult === 'surrender') {
                // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦åœ¨æŠ•é™åˆ—è¡¨ä¸­ï¼ˆä½¿ç”¨å­—ç¬¦ä¸²æ¯”è¾ƒï¼‰
                isSurrendered = state.user && surrenderedStr.includes(String(state.user.id));
                isWinner = state.user && String(winner.user_id) === String(state.user.id);
                
                if (isSurrendered) {
                    resultTitle = 'ğŸ³ï¸ ä½ å·²æŠ•é™';
                    resultColor = '#ff6b6b';
                } else if (isWinner) {
                    resultTitle = 'ğŸ‰ å¯¹æ–¹æŠ•é™ï¼Œä½ è·èƒœï¼';
                    resultColor = '#ffd700';
                } else {
                    resultTitle = 'ğŸ¯ å¯¹æˆ˜ç»“æŸ';
                    resultColor = '#ff6b6b';
                }
            } else if (isDraw) {
                resultTitle = 'ğŸ¤ å¹³å±€ï¼';
                resultColor = '#a855f7';
            } else {
                isWinner = state.user && String(winner.user_id) === String(state.user.id);
                resultTitle = isWinner ? 'ğŸ‰ èƒœåˆ©ï¼' : 'ğŸ’” å¤±è´¥';
                resultColor = isWinner ? '#ffd700' : '#ff6b6b';
            }
            
            board.innerHTML = `
                <!-- å¯¹æˆ˜ç»“æœ -->
                <div class="battle-result" style="text-align: center; margin: 20px 0;">
                    <h3 style="color: ${resultColor}; margin-bottom: 15px;">
                        ${resultTitle}
                    </h3>
                    ${surrenderResult !== 'draw' && !isDraw ? `
                    <div class="winner-info" style="margin: 15px 0; padding: 15px; background: var(--bg-secondary); border-radius: 8px;">
                        <div style="font-size: 1.5rem; margin-bottom: 10px;">${isWinner ? 'ğŸ‰ èƒœåˆ©' : 'ğŸ’” å¤±è´¥'}</div>
                        <div style="font-weight: bold;">${winner.username}</div>
                        <div style="font-size: 2rem; color: var(--accent-yellow); margin: 10px 0;">${winner.count || 0}æ¬¡</div>
                    </div>
                    ` : `
                    <div class="draw-info" style="margin: 15px 0; padding: 15px; background: var(--bg-secondary); border-radius: 8px;">
                        <div style="font-size: 1.5rem; margin-bottom: 10px;">ğŸ¤ å¹³å±€</div>
                        <div style="color: var(--text-secondary);">
                            ${surrenderResult === 'draw' ? 'æ‰€æœ‰ç©å®¶éƒ½å·²æŠ•é™' : `åŒæ–¹éƒ½è¾¾åˆ°äº† ${sorted[0].count || 0} æ¬¡`}
                        </div>
                    </div>
                    `}
                    
                    <!-- æœ€ç»ˆæ’å -->
                    <div class="final-rank" style="margin-top: 20px;">
                        <h4 style="margin-bottom: 10px; color: var(--accent-cyan);">æœ€ç»ˆæ’å</h4>
                        ${sorted.map((player, idx) => {
                            const rankDisplay = isDraw && idx < 2 ? 'ğŸ¤' : 
                                              idx === 0 ? 'ğŸ¥‡' : 
                                              idx === 1 ? 'ğŸ¥ˆ' : 
                                              idx === 2 ? 'ğŸ¥‰' : `#${idx + 1}`;
                            return `
                                <div class="board-item">
                                    <span class="board-rank">${rankDisplay}</span>
                                    <span class="board-name">${player.username}</span>
                                    <span class="board-score">${player.count || 0}æ¬¡</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- å†æ¥ä¸€å±€æŒ‰é’® -->
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn primary" onclick="battleRematch()" style="margin-right: 10px;">ğŸ”„ å†æ¥ä¸€å±€</button>
                        <button class="btn ghost" onclick="leaveBattle()">ğŸ‘‹ ç¦»å¼€æˆ¿é—´</button>
                    </div>
                </div>
            `;
        }

        function handleBattleKey(e) {
            if (state.currentView === 'battle' && state.battleState?.started && !state.battleState?.finished) {
                if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                    // è¯·æ±‚é™æµæ£€æŸ¥
                    if (rateLimiter.canRequest()) {
                        rateLimiter.consume();
                        battleTap();
                    }
                }
            }
        }

        // ========== è®¾ç½® ==========
        async function changePassword() {
            const oldPwd = el('oldPwdInput').value;
            const newPwd = el('newPwdInput').value;
            if (newPwd.length < 6) {
                alert('æ–°å¯†ç è‡³å°‘6ä½');
                return;
            }
            try {
                await api.changePassword(oldPwd, newPwd);
                alert('å¯†ç ä¿®æ”¹æˆåŠŸ');
            } catch (err) {
                alert(err.message);
            }
        }

        async function resetPassword() {
            const username = el('resetUserInput').value.trim();
            const newPwd = el('resetPwdInput').value;
            if (username.length < 3 || newPwd.length < 6) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }
            try {
                await api.resetPassword(username, newPwd);
                alert('å¯†ç å·²é‡ç½®ï¼Œè¯·ç”¨æ–°å¯†ç ç™»å½•');
            } catch (err) {
                alert(err.message);
            }
        }

        async function changeUsername() {
            const newUsername = el('newUsernameInput').value.trim();
            const password = el('usernameConfirmPwd').value;
            if (newUsername.length < 3) {
                alert('ç”¨æˆ·åè‡³å°‘3ä¸ªå­—ç¬¦');
                return;
            }
            if (!password) {
                alert('è¯·è¾“å…¥å¯†ç ç¡®è®¤');
                return;
            }
            try {
                const res = await api.changeUsername(newUsername, password);
                alert('ç”¨æˆ·åä¿®æ”¹æˆåŠŸ');
                // æ›´æ–°æœ¬åœ°çŠ¶æ€
                if (state.user) {
                    state.user.username = res.new_username;
                    renderUserCard();
                }
                // æ¸…ç©ºè¾“å…¥æ¡†
                el('newUsernameInput').value = '';
                el('usernameConfirmPwd').value = '';
            } catch (err) {
                alert(err.message);
            }
        }

        // ========== å¯¹æˆ˜å†å²å’Œæ’è¡Œæ¦œ ==========
        async function loadBattleRanking() {
            try {
                const res = await api.battleRanking();
                renderBattleRanking(res.ranking, res.my_stats);
            } catch (err) {
                console.error('åŠ è½½å¯¹æˆ˜æ’è¡Œæ¦œå¤±è´¥:', err);
            }
        }

        function renderBattleRanking(ranking, myStats) {
            // æ›´æ–°æˆ‘çš„æˆ˜ç»©
            if (myStats) {
                el('myBattleScore').textContent = myStats.score || 0;
                el('myBattleWins').textContent = myStats.wins || 0;
                el('myBattleLosses').textContent = myStats.losses || 0;
                el('myBattleDraws').textContent = myStats.draws || 0;
            }

            const listEl = el('battleRankingList');
            if (!ranking || ranking.length === 0) {
                listEl.innerHTML = '<div class="empty-state">æš‚æ— æ’è¡Œæ•°æ®</div>';
                return;
            }

            listEl.innerHTML = ranking.map(item => {
                const rankEmoji = item.rank === 1 ? 'ğŸ¥‡' : item.rank === 2 ? 'ğŸ¥ˆ' : item.rank === 3 ? 'ğŸ¥‰' : `#${item.rank}`;
                return `
                    <div class="ranking-item">
                        <span class="rank">${rankEmoji}</span>
                        <span class="name">${item.username}</span>
                        <span class="stats">
                            <span class="score">${item.score}åˆ†</span>
                            <span>${item.wins}èƒœ/${item.losses}è´Ÿ/${item.draws}å¹³</span>
                        </span>
                    </div>
                `;
            }).join('');
        }

        async function loadBattleHistory() {
            try {
                const res = await api.battleHistory(20, 0);
                renderBattleHistory(res.history);
            } catch (err) {
                console.error('åŠ è½½å¯¹æˆ˜å†å²å¤±è´¥:', err);
            }
        }

        function renderBattleHistory(history) {
            const listEl = el('battleHistoryList');
            if (!history || history.length === 0) {
                listEl.innerHTML = '<div class="empty-state">æš‚æ— å¯¹æˆ˜è®°å½•</div>';
                return;
            }

            listEl.innerHTML = history.map(item => {
                // åˆ¤æ–­å½“å‰ç”¨æˆ·çš„èƒœè´Ÿ
                let resultClass = '';
                let resultText = '';
                if (item.result_type === 'draw') {
                    resultClass = 'draw';
                    resultText = 'å¹³å±€';
                } else if (state.user && item.winner_id === state.user.id) {
                    resultClass = 'win';
                    resultText = 'èƒœåˆ©';
                } else if (state.user && (item.player1.id === state.user.id || item.player2.id === state.user.id)) {
                    resultClass = 'lose';
                    resultText = 'å¤±è´¥';
                } else {
                    // ä¸æ˜¯å½“å‰ç”¨æˆ·å‚ä¸çš„å¯¹æˆ˜
                    if (item.winner_id === item.player1.id) {
                        resultText = `${item.player1.name}èƒœ`;
                    } else if (item.winner_id === item.player2.id) {
                        resultText = `${item.player2.name}èƒœ`;
                    } else {
                        resultText = 'å¹³å±€';
                    }
                }

                const timeStr = new Date(item.created_at).toLocaleString('zh-CN', { 
                    month: 'numeric', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });

                return `
                    <div class="history-item">
                        <div class="players">
                            <span>${item.player1.name}(${item.player1.count})</span>
                            <span class="vs">VS</span>
                            <span>${item.player2.name}(${item.player2.count})</span>
                        </div>
                        <span class="result ${resultClass}">${resultText}</span>
                        <span class="time">${timeStr}</span>
                    </div>
                `;
            }).join('');
        }

        async function battleRematch() {
            if (!state.battleCode) return;
            try {
                const res = await api.battleRematch(state.battleCode);
                state.battleCode = res.code;
                state.battleIsCreator = true;
                state.battleState = res.state;
                startBattlePolling();
                updateBattleUI();
                alert('å·²åˆ›å»ºæ–°æˆ¿é—´ï¼Œç­‰å¾…å…¶ä»–ç©å®¶åŠ å…¥');
            } catch (err) {
                alert(err.message || 'åˆ›å»ºå†æ¥ä¸€å±€å¤±è´¥');
            }
        }

        // ========== åˆ·æ–°UI ==========
        function refreshUI() {
            updateStatus();
            updateStats();
            renderCalendar();
            renderUserCard();
            renderAchievements();
        }

        // ========== åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', async () => {
            setupBanana();
            await loadUser();
            await ensureMonthRecords(state.displayMonth);
            renderCalendar();
        });
    </script>
</body>
</html>

</html>
